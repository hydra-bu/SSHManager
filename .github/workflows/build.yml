name: Build SSH Manager

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Build Project
      run: |
        xcodebuild -project SSHManager.xcodeproj \
          -scheme SSHManager \
          -destination 'platform=macOS' \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      env:
        DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

    - name: Archive Application
      run: |
        xcodebuild -project SSHManager.xcodeproj \
          -scheme SSHManager \
          -destination 'platform=macOS' \
          -archivePath "SSHManager.xcarchive" \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      env:
        DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

    - name: Create Export Options Plist
      run: |
        tee exportOptions.plist > /dev/null << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>destination</key>
    <string>export</string>
</dict>
</plist>
EOF

    - name: Export Application
      run: |
        xcodebuild -exportArchive \
          -archivePath "SSHManager.xcarchive" \
          -exportPath "." \
          -exportOptionsPlist "exportOptions.plist"
      env:
        DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SSH-Manager-App
        path: SSHManager.app
        retention-days: 30

    - name: Create DMG
      run: |
        hdiutil create -volname "SSHManager" -srcfolder "SSHManager.app" -ov -format UDZO "SSHManager.dmg"

    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: SSH-Manager-DMG
        path: SSHManager.dmg
        retention-days: 30