name: Build SSH Manager

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Build Project
      run: |
        xcodebuild -project SSHManager.xcodeproj \
          -scheme SSHManager \
          -destination 'platform=macOS' \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      env:
        DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

    - name: Find Built Application
      run: |
        # Find the built application in the DerivedData directory
        find ~/Library/Developer/Xcode/DerivedData -name "SSHManager.app" -type d | head -n 1 > app_path.txt
        if [ ! -s app_path.txt ]; then
          echo "ERROR: Could not find built SSHManager.app"
          exit 1
        fi
        APP_PATH=$(cat app_path.txt)
        echo "Found app at: $APP_PATH"
        cp -r "$APP_PATH" ./SSHManager.app

    - name: Verify Application
      run: |
        if [ ! -d "SSHManager.app" ]; then
          echo "ERROR: SSHManager.app was not created"
          exit 1
        fi
        echo "SSHManager.app created successfully"
        ls -la SSHManager.app

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SSH-Manager-App
        path: SSHManager.app
        retention-days: 30

    - name: Create DMG
      run: |
        hdiutil create -volname "SSHManager" -srcfolder "SSHManager.app" -ov -format UDZO "SSHManager.dmg"

    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: SSH-Manager-DMG
        path: SSHManager.dmg
        retention-days: 30